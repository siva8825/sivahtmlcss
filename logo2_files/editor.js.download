window["editor_g_state"]=null;window["doing_redo_undo"]=false;function restart_editor(){if(window["editor_g_state"]!==null){return;}
window["editor_g_state"]={optimal_width:null,optimal_height:null,canvas:null,scaleFactor:1,dynamic_nav:null,canvases:{},active_canvas_id:null};}
restart_editor();function shutdown_editor(){for(let _canvas of Object.values(editor_g_state.canvases)){_canvas.clear();_canvas.dispose();}
window["editor_g_state"]=null;}
function is_color_picking_now(){return $('.ColorPickerInput').hasClass('show');}
function canvas_undo(){if(editor_g_state.canvas.historyUndo.length===0){return;}
if(window["doing_redo_undo"]===true){return;}
window["doing_redo_undo"]=true;editor_g_state.canvas.undo(function(){window["doing_redo_undo"]=false;});}
function canvas_redo(){if(editor_g_state.canvas.historyRedo.length===0){return;}
if(window["doing_redo_undo"]===true){return;}
window["doing_redo_undo"]=true;editor_g_state.canvas.redo(function(){window["doing_redo_undo"]=false;});}
function canvas_save(){editor_g_state.canvas.onHistory();}
async function init_editor(identifier,fabric_json){restart_editor();if(editor_g_state.dynamic_nav===null){editor_g_state.dynamic_nav=document.getElementById('dynamic_nav');}
let _elem_id=`editor-${identifier}`;let _is_new=!(identifier in editor_g_state.canvases);$('#editor_container > div').hide();if(_is_new){_is_new=true;let new_canvas=$('<canvas>')
new_canvas.attr('id',_elem_id);new_canvas.prependTo('#editor_container');editor_g_state.canvases[identifier]=new fabric.Canvas(_elem_id,{preserveObjectStacking:true,stopContextMenu:true,});}else{$(`#${_elem_id}`).parent().show();}
editor_g_state.canvas=editor_g_state.canvases[identifier];editor_g_state.active_canvas_id=identifier;if(_is_new){editor_g_state.canvas.offHistory();editor_g_state.canvas.extraProps.push('svg_id','font_id','cat');editor_g_state.canvas.on({'selection:updated':render_dynamic_menu,'selection:created':render_dynamic_menu,'object:modified':render_dynamic_menu,'selection:cleared':hide_dynamic_menu,});editor_g_state.canvas.loadFromJSON(fabric_json,function(){editor_g_state.canvas.forEachObject(function(obj){if(obj.type==='i-text'||obj.type==='text'){obj.set({editable:false});}});});let loaded_obj=editor_g_state.canvas.getObjects();for(let object of editor_g_state.canvas.getObjects()){if(!object.hasOwnProperty('svg_id')){continue;}
let fabric_svg=await fabric_svg_loader(loaded_svg[object["svg_id"]],'by_string');let raw_svg=fabric.util.groupSVGElements(fabric_svg.objects,fabric_svg.options);raw_svg.set({top:object.top,left:object.left,originX:object.originX,originY:object.originY,cat:object.cat,svg_id:object.svg_id,fill:object.fill,globalCompositeOperation:object.globalCompositeOperation,angle:object.angle,});raw_svg.scale(object.scaleX);fabric_change_united_color(raw_svg,object.fill);editor_g_state.canvases[identifier].add(raw_svg);editor_g_state.canvases[identifier].remove(object);}
editor_g_state.optimal_width=document.getElementById('editor_container').clientWidth;editor_g_state.optimal_height=document.getElementById('editor_container').clientHeight;editor_g_state.canvas.discardActiveObject();let objects=new fabric.ActiveSelection(editor_g_state.canvas.getObjects(),{canvas:editor_g_state.canvas,});objects.set({top:editor_g_state.optimal_height/2,left:editor_g_state.optimal_width/2,originX:'center',originY:'center'});let content_size=await get_content_dim(editor_g_state.canvas);if(content_size.width/content_size.height>editor_g_state.optimal_width/editor_g_state.optimal_height){objects.scaleToWidth(editor_g_state.optimal_width/1.4);}else{objects.scaleToHeight(editor_g_state.optimal_height/1.65);}
editor_g_state.canvas.setActiveObject(objects);editor_g_state.canvas.discardActiveObject();editor_g_state.canvas.onHistory();editor_g_state.canvas.clearHistory();}
resizeCanvas(_is_new);for(let obj of editor_g_state.canvas.getObjects()){if(obj.type==="i-text"&&obj.cat==="base_text"){editor_g_state.canvas.setActiveObject(obj);break;}}}
function resizeCanvas(is_first_render){let editor_container_elem=document.getElementById('editor_container');let box_width=editor_container_elem.clientWidth;let box_height=editor_container_elem.clientHeight;let scaleX=box_width/editor_g_state.optimal_width;let scaleY=box_height/editor_g_state.optimal_height;editor_g_state.scaleFactor=Math.min(scaleX,scaleY);editor_g_state.canvas.setWidth(editor_g_state.optimal_width*editor_g_state.scaleFactor);editor_g_state.canvas.setHeight(editor_g_state.optimal_height*editor_g_state.scaleFactor);editor_g_state.canvas.setZoom(editor_g_state.scaleFactor);editor_g_state.canvas.calcOffset();editor_g_state.canvas.requestRenderAll();if(is_first_render===true){initCenteringGuidelines(editor_g_state.canvas);initAligningGuidelines(editor_g_state.canvas);}}
function get_data_less_json(idx){let canvas=idx?editor_g_state.canvases[idx]:editor_g_state.canvas;let json_out=canvas.toDatalessJSON(['svg_id','font_id','cat']);return make_data_less_json(json_out);}
function get_canvas_by_layout(layout){return editor_g_state.canvases[layout];}
function delete_object(){let active=editor_g_state.canvas.getActiveObject();editor_g_state.canvas.discardActiveObject();if(active){editor_g_state.canvas.remove(active);}
editor_g_state.canvas.renderAll();}
function bake_template(template_id,baker){let $tpl=$($('#'+template_id).html());baker($tpl);return $tpl.prop('outerHTML');}
function render_dynamic_menu(){hide_dynamic_menu();let dy_nav_html='<div class="toolbar__nav"><div class="toolbar-row"><div class="d-flex align-items-center flex-md-wrap flex-md-shrink-1 flex-shrink-0 gap-2">';let active=editor_g_state.canvas.getActiveObject();if(!active){return;}
switch(active.type){case 'i-text':dy_nav_html+=bake_template('dyn_color',function(tpl){tpl.css('padding-left','.5rem');tpl.find('button.pickr').css('background-color',active.fill);});dy_nav_html+=bake_template('dyn_font_family',function(tpl){});dy_nav_html+=bake_template('dyn_range_input',function(tpl){tpl.find('input[type=range]').attr({'value':active.fontSize,'data-kind':'font_size','min':20,'max':500});tpl.find('input[type=number]').attr({'value':Math.round(active.fontSize),'data-kind':'font_size'});tpl.find('.dyn_label').text('Size');tpl.find('.dyn_icon').addClass('icon-size me-2');});dy_nav_html+=bake_template('dyn_range_input',function(tpl){tpl.find('input[type=range]').attr({'value':active.charSpacing,'data-kind':'char_spacing','min':-100,'max':200});tpl.find('input[type=number]').attr({'value':Math.round(active.charSpacing),'data-kind':'char_spacing'});tpl.find('.dyn_main_lbl').remove();tpl.find('.dyn_label').text('Letter spacing');tpl.find('.dyn_icon').addClass('icon-kerning');});break;case 'group':case 'path':dy_nav_html+=bake_template('dyn_color',function(tpl){tpl.css('padding-left','.5rem');tpl.find('button.pickr').css('background-color',active.fill);});dy_nav_html+=bake_template('dyn_range_input',function(tpl){tpl.find('input[type=range]').attr({'value':active.getScaledWidth(),'data-kind':'scale','min':20,'max':500});tpl.find('input[type=number]').attr({'value':Math.round(active.getScaledWidth()),'data-kind':'scale'});tpl.find('.dyn_label').text('Scale');tpl.find('.dyn_icon').addClass('icon-size me-2');});break;case 'rect':case 'circle':dy_nav_html+=bake_template('dyn_color',function(tpl){tpl.css('padding-left','.5rem');tpl.find('button.pickr').css('background-color',active.fill);});dy_nav_html+=bake_template('dyn_range_input',function(tpl){tpl.find('input[type=range]').attr({'value':active.getScaledWidth(),'data-kind':'scale','min':20,'max':500});tpl.find('input[type=number]').attr({'value':Math.round(active.getScaledWidth()),'data-kind':'scale'});tpl.find('.dyn_label').text('Scale');tpl.find('.dyn_icon').addClass('icon-size me-2');});break;default:}
dy_nav_html+=bake_template('dyn_range_input',function(tpl){tpl.find('input[type=range]').attr({'value':active.angle,'data-kind':'angle','min':0,'max':360});tpl.find('input[type=number]').attr({'value':Math.round(active.angle),'data-kind':'angle'});tpl.find('.dyn_main_lbl').remove();tpl.find('.dyn_label').text('Rotation');tpl.find('.dyn_icon').addClass('icon-rotate-left');});dy_nav_html+=bake_template('dyn_delete',function(tpl){});dy_nav_html+='</div></div></div>';editor_g_state.dynamic_nav.innerHTML=dy_nav_html;run_after_each_select(active.fill);$(editor_g_state.dynamic_nav).removeClass('rolled_up');$('.dynamic_input_items').on('click',function(){let changed=false;switch($(this).attr('data-kind')){case "delete":delete_object();changed=true;break;}}).on('keyup',function(){switch($(this).attr('data-kind')){case "active_text":change_active_text();break;}}).on('input',function(){let elem=$(this);let kind=elem.attr('data-kind');let allowed=['font','font_size','char_spacing','color','svg','scale','angle'];if(!allowed.includes(kind)){return;}
window[`change_${kind}`]($(this));}).on('mouseup',function(){let elem=$(this);let kind=elem.attr('data-kind');let allowed=['font','font_size','char_spacing','color','svg','scale','angle'];if(!allowed.includes(kind)){return;}
window[`change_${kind}`]($(this));canvas_save();});run_tooltip();}
function hide_dynamic_menu(){$(editor_g_state.dynamic_nav).addClass('rolled_up');setTimeout(editor_g_state.dynamic_nav.innerHTML='',150);$('.dynamic_input_items').off('click').off('change').off('keyup');$('.tooltip').hide();}
function change_active_text(){editor_g_state.canvas.getActiveObject().set('text',document.getElementById('input_change_text').value);editor_g_state.canvas.renderAll();canvas_save();}
function listFonts(){let{fonts}=document;const it=fonts.entries();let arr=[];let done=false;while(!done){const font=it.next();if(!font.done){arr.push(font.value[0]);}else{done=font.done;}}
return arr;}
async function change_svg(){let selected_item=document.getElementById('svg_selection').value;let active=editor_g_state.canvas.getActiveObject();document.getElementById('loading').style.display='block';await asset_loader({svg:[selected_item]});fabric.loadSVGFromString(loaded_svg[selected_item],function(objects,options){let svg=fabric.util.groupSVGElements(objects,options);svg.svg_id=selected_item;svg.cat=active.cat;svg.top=active.top;svg.left=active.left;svg.fill=active.fill;svg.originX=active.originX;svg.originY=active.originY;svg.scaleToWidth(active.getScaledWidth());fabric_change_united_color(svg,active.fill);editor_g_state.canvas.add(svg);editor_g_state.canvas.setActiveObject(svg);});document.getElementById('loading').style.display='none';editor_g_state.canvas.remove(active);editor_g_state.canvas.renderAll();}
async function change_font(){let selected_item=document.getElementById('font_selection').value;if(loaded_font[selected_item]===undefined){document.getElementById('loading').style.display='block';await asset_loader({font:[selected_item]});document.getElementById('loading').style.display='none';}
editor_g_state.canvas.getActiveObject().fontFamily="f"+selected_item;editor_g_state.canvas.getActiveObject().set('font_id',selected_item);editor_g_state.canvas.renderAll();}
function change_char_spacing($this){let input_value=$this.val();if($this.attr('type')==='number'){if(input_value<-100)input_value=-100;if(input_value>200)input_value=200;}
editor_g_state.canvas.getActiveObject().set('charSpacing',input_value);editor_g_state.canvas.renderAll();$('input[data-kind="'+$this.attr('data-kind')+'"]').not($this).val(Math.round(input_value));}
function change_font_size($this){let input_value=$this.val();if($this.attr('type')==='number'){if(input_value<20)input_value=20;if(input_value>500)input_value=500;}
editor_g_state.canvas.getActiveObject().set('fontSize',input_value);editor_g_state.canvas.renderAll();$('input[data-kind="'+$this.attr('data-kind')+'"]').not($this).val(Math.round(input_value));}
function change_color(color){fabric_change_united_color(editor_g_state.canvas.getActiveObject(),color);editor_g_state.canvas.requestRenderAll();}
function change_scale($this){let input_value=$this.val();if($this.attr('type')==='number'){if(input_value<20)input_value=20;if(input_value>500)input_value=500;}
editor_g_state.canvas.getActiveObject().scaleToWidth(input_value*editor_g_state.scaleFactor);editor_g_state.canvas.renderAll();$('input[data-kind="'+$this.attr('data-kind')+'"]').not($this).val(Math.round(input_value));}
function change_angle($this){let input_value=$this.val();if($this.attr('type')==='number'){if(input_value<0)input_value=0;if(input_value>360)input_value=360;}
editor_g_state.canvas.getActiveObject().rotate(input_value);editor_g_state.canvas.renderAll();$('input[data-kind="'+$this.attr('data-kind')+'"]').not($this).val(Math.round(input_value));}
function run_after_each_select(default_color=null){let _color_pick_selector=".myColorPicker";if(document.querySelector(_color_pick_selector)){let pickr=Pickr.create({el:_color_pick_selector,theme:'monolith',inline:true,showAlways:true,useAsButton:true,default:default_color,swatches:null,lockOpacity:true,defaultRepresentation:'HEX',appClass:'color-picker',components:{preview:false,opacity:false,hue:true,interaction:{hex:false,rgba:false,hsla:false,hsva:false,cmyk:false,input:true,clear:false,save:false}}});let selected_color=null
pickr.off('change').on('change',(color,source,instance)=>{editor_g_state.canvas.offHistory();selected_color=color.toHEXA().toString();if($('.colorPickerType:checked').first().attr('data-color-type')==="brand"){fabric_change_united_color_by_canvas(editor_g_state.canvas,selected_color);}else{change_color(selected_color);}
$('button.pickr').css('background-color',selected_color);});pickr.on('changestop',(source,instance)=>{console.log('Selected color: ',selected_color);canvas_save();if($('.colorPickerType:checked').first().attr('data-color-type')==="brand"){editor_g_state.canvas.fire('brand:color:changed',selected_color);}});}}
async function change_font_safe(face,identifier){let my_spin=$('.page_spinner');my_spin.removeClass('hide-me');await asset_loader({font:[face]});editor_g_state.canvas.offHistory();editor_g_state.canvas.getActiveObject().set({fontFamily:face,font_id:identifier});editor_g_state.canvas.renderAll();canvas_save();my_spin.addClass('hide-me');}
async function change_svg_safe(identifier){await asset_loader({svg:[identifier]});editor_g_state.canvas.offHistory();await new Promise(resolve=>{fabric.loadSVGFromString(loaded_svg[identifier],function(objects,options){let svg=fabric.util.groupSVGElements(objects,options);svg.svg_id=identifier;let active=editor_g_state.canvas.getActiveObject();svg.cat=active.cat;svg.top=active.top;svg.left=active.left;svg.fill=active.fill;svg.originX=active.originX;svg.originY=active.originY;svg.scaleToWidth(active.getScaledWidth());fabric_change_united_color(svg,active.fill);editor_g_state.canvas.remove(active);editor_g_state.canvas.add(svg);editor_g_state.canvas.setActiveObject(svg);editor_g_state.canvas.renderAll();resolve(true);});});canvas_save();}