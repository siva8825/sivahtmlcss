function get_transferred_img(images,configs,brand_color){return new Promise(function(resolve,reject){let canvas=document.createElement('canvas');canvas.width=configs['width'];canvas.height=configs['height'];if(canvas.getContext){let ctx=canvas.getContext("2d");ctx.webkitImageSmoothingEnabled=true;ctx.imageSmoothingEnabled=true;let logo_places=configs['places'];if(logo_places['white']!==undefined&&logo_places['white'].length>0){let rendered_part=colored_canvas_builder(canvas.width,canvas.height,logo_places['white'],images,'#fff');ctx.drawImage(rendered_part,0,0);rendered_part=canvas_remover(rendered_part);}
if(logo_places['auto_color']!==undefined&&logo_places['auto_color'].length>0){let auto_color=(tinycolor(brand_color).getLuminance()<0.5)?'#fff':'#080808';let rendered_part=colored_canvas_builder(canvas.width,canvas.height,logo_places['auto_color'],images,auto_color);ctx.drawImage(rendered_part,0,0);rendered_part=canvas_remover(rendered_part);}
if(logo_places['colored']!==undefined&&logo_places['colored'].length>0){let rendered_part=colored_canvas_builder(canvas.width,canvas.height,logo_places['colored'],images,brand_color);ctx.drawImage(rendered_part,0,0);rendered_part=canvas_remover(rendered_part);}
if(logo_places['original_color']!==undefined&&logo_places['original_color'].length>0){canvas_places_drawer(ctx,logo_places['original_color'],images);}
let dataURL=canvas.toDataURL({width:canvas.width,height:canvas.height,left:0,top:0,format:'png',multiplier:2,quality:1});canvas=canvas_remover(canvas);resolve(dataURL);}});}
function colored_canvas_builder(width,height,logo_places,raw_logo,color){let canvas=document.createElement('canvas');canvas.width=width;canvas.height=height;let ctx=canvas.getContext("2d");canvas_places_drawer(ctx,logo_places,raw_logo);ctx.globalCompositeOperation='source-in';ctx.fillStyle=color;ctx.fillRect(0,0,canvas.width,canvas.height);return canvas;}
function canvas_places_drawer(ctx,logo_places,raw_logo){for(let i=0;i<logo_places.length;i++){let new_places=boundary_fixer(logo_places[i],raw_logo['layout'+logo_places[i]['layout']]);if(typeof logo_places[i]['opacity']!=="undefined"){ctx.globalAlpha=logo_places[i]['opacity'];}
let dev_mode=false;if((typeof logo_places[i]['a']!=="undefined"&&logo_places[i]['a']>0)||(typeof logo_places[i]['t']!=="undefined"&&logo_places[i]['t'].length>0)){let center_x=new_places['x']+(new_places['w']/2);let center_y=new_places['y']+(new_places['h']/2);ctx.save();ctx.translate(center_x,center_y);if(logo_places[i]['a']>0)ctx.rotate((logo_places[i]['a']*Math.PI)/180);if(logo_places[i]['t'].length>0)ctx.transform(...logo_places[i]['t']);ctx.translate(-center_x,-center_y);draw_image(ctx,raw_logo,logo_places[i],new_places,dev_mode);ctx.restore();}else{draw_image(ctx,raw_logo,logo_places[i],new_places,dev_mode);}}}
function draw_image(ctx,raw_logo,places,new_places,dev_mode){if(dev_mode){ctx.fillStyle="yellow";ctx.fillRect(places['x'],places['y'],places['w'],places['h']);}
ctx.drawImage(raw_logo['layout'+places['layout']],new_places['x'],new_places['y'],new_places['w'],new_places['h']);}
function boundary_fixer(item,img){let new_x=item['x'];let new_y=item['y'];let new_width=item['w'];let new_height=item['h'];if(item['w']/item['h']<img.width/img.height){new_height=img.height*new_width/img.width;new_y=(item['h']-new_height)/2+item['y'];}else{new_width=img.width*new_height/img.height;if(item['h_align']==='center'){new_x=(item['w']-new_width)/2+item['x'];}}
return{x:new_x,y:new_y,w:new_width,h:new_height}}
async function perspective_pre_loader(loadable_assets){let loaded_assets={};for(const[key,value]of Object.entries(loadable_assets)){let temp_arr=[];for(let i=0;i<value.length;i++){let temp=await image_loader(value[i]);temp_arr.push(temp);}
loaded_assets[key]=temp_arr;}
return loaded_assets;}
function perspective_renderer(preview_config,loaded_assets,destination_canvas,transferred_img,brand_color){let canvas=destination_canvas;canvas.width=preview_config['width'];canvas.height=preview_config['height'];if(canvas.getContext){let ctx=canvas.getContext("2d");if('color_mask_layer'in loaded_assets){ctx.fillStyle=brand_color;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.globalCompositeOperation='destination-in';ctx.drawImage(loaded_assets['color_mask_layer'][0],0,0);}
if('background_layers'in loaded_assets){ctx.globalCompositeOperation='destination-over';ctx.drawImage(loaded_assets['background_layers'][0],0,0);}
if('topping_layers'in loaded_assets){ctx.globalCompositeOperation='source-over';ctx.drawImage(loaded_assets['topping_layers'][0],0,0);}
ctx.globalCompositeOperation='source-over';ctx.drawImage(transferred_img,0,0);if('final_layers'in loaded_assets){if(preview_config.options&&preview_config.options.final_layers&&preview_config.options.final_layers.length>0){if(preview_config.options.final_layers[0][0]==='blending'){ctx.globalCompositeOperation=preview_config.options.final_layers[0][1];}}
ctx.drawImage(loaded_assets['final_layers'][0],0,0);}}
return canvas;}
function perspective_image_maker(preview_config,loaded_assets,transferred_img,brand_color){let canvas=document.createElement('canvas');canvas=perspective_renderer(preview_config,loaded_assets,canvas,transferred_img,brand_color);let image=canvas.toDataURL('image/png');canvas=canvas_remover(canvas);return image;}
function loadable_layout_discovery(logo_places){let result={};for(const[key,value]of Object.entries(logo_places)){for(const[key2,value2]of Object.entries(value)){if(!("layout"+value2['layout']in result)){result["layout"+value2['layout']]='';}}}
return result;}
function render_mockup(layouts,config,color_config,destination_box,logo_map){let mockup_wrapper=$(destination_box)[0];if(mockup_wrapper.length===0){mockup_wrapper=null;}
if(mockup_wrapper===null){mockup_wrapper=mockup_wrapper=document.querySelector(destination_box)}
if(mockup_wrapper===null){mockup_wrapper=document.getElementById(destination_box);}
if(!mockup_wrapper){console.warn('mockup box issue');return false;}
let fragment=document.createDocumentFragment();let mockup=document.createElement('div');fragment.appendChild(mockup);mockup.classList.add('css_mockup');mockup.style.width=config['width']+'px';mockup.style.height=config['height']+'px';for(let[idx,layer]of config['layers'].entries()){let el_container=document.createElement('div');let inner_box=null;if(layer.hasOwnProperty('box_width')){inner_box=document.createElement('div');inner_box.style.position='absolute';inner_box.style.width=layer.box_width+'px';inner_box.style.height=layer.box_height+'px';inner_box.style.left=layer.box_left+'px';inner_box.style.top=layer.box_top+'px';inner_box.classList.add('center_object');el_container.appendChild(inner_box);}
let wrapper=(inner_box===null||(layer.hasOwnProperty('bg_wrapper')&&layer.bg_wrapper==='global'))?el_container:inner_box;if(layer.hasOwnProperty('rotation')){wrapper.style.transform='rotate('+layer.rotation+'deg)';}
if(layer.hasOwnProperty('matrix3d')){wrapper.style.transform='matrix3d('+layer.matrix3d+')';wrapper.style.transformOrigin='0 0 0';}
if(layer.hasOwnProperty('bg_color')){let color;if(layer.bg_color==='static'){color=layer.color_value;}else if(layer.bg_color==='primary_color'){color=color_config.brand_color;}else if(layer.bg_color==='secondary_color'){color=color_config.secondary_color;}
wrapper.style.backgroundColor=color;wrapper.classList.add(layer.bg_color);}
if(layer.hasOwnProperty('mask')){wrapper.classList.add('css_mockup_mask');if(layer.mask==='static'){wrapper.style.maskImage='url("'+layer.mask_url+'")';wrapper.style.webkitMaskImage='url("'+layer.mask_url+'")';}else if(layer.mask==='logo'){wrapper.style.maskImage='url("'+layouts[logo_map[layer.logo_map]]+'")';wrapper.style.webkitMaskImage='url("'+layouts[logo_map[layer.logo_map]]+'")';}
if(layer.hasOwnProperty('mask_position'))wrapper.style.maskPosition=layer.mask_position;if(layer.hasOwnProperty('mask_size'))wrapper.style.maskSize=layer.mask_size;}
if(layer.hasOwnProperty('img')){let image=document.createElement('img');if(layer.img==='static'){image.src=layer.img_url;}else if(layer.img==='logo'){image.src=layouts[logo_map[layer.logo_map]];}
wrapper.appendChild(image);}
if(layer.hasOwnProperty('opacity')){wrapper.style.opacity=layer.opacity;}
mockup.appendChild(el_container);}
mockup_wrapper.appendChild(fragment);}